<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="theme-color" content="#2ecc71">
    <meta name="description" content="Gerador de Escala Mensal para vigilantes - PWA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Gerador de Escala Mensal</title>

    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --verde: #2ecc71;
            --cinza: #e6e6e6;
            --borda: #cfcfcf;
            --fundo: #f5f7f8;
            --azulNome: #0044cc;
            --roxo: #9b59b6;
            --laranja: #e67e22;
            --azul: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--fundo);
            min-height: 100vh;
            padding: 20px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .app-title {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .app-subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .pwa-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            display: none;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }

        .control-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--verde);
            padding-bottom: 5px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 600;
            font-size: 0.9rem;
        }

        textarea, select, input[type="month"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
        }

        textarea:focus, select:focus, input[type="month"]:focus {
            outline: none;
            border-color: var(--azul);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: var(--azul);
            color: white;
        }

        .btn-success {
            background: var(--verde);
            color: white;
        }

        .btn-warning {
            background: #e67e22;
            color: white;
        }

        .btn-install {
            background: #9b59b6;
            color: white;
            display: none;
        }

        .escala-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .escala-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .escala-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .escala-subtitle {
            font-size: 1rem;
            color: #7f8c8d;
        }

        .nome-vigilante {
            color: var(--azulNome);
            font-weight: 700;
        }

        .table-responsive {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: #009879;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #eee;
        }

        tr:hover td {
            background: #f9f9f9;
        }

        td:first-child {
            font-weight: 600;
            background: #f8f9fa;
        }

        select.turno-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }

        select.turno-select:focus {
            outline: none;
            border-color: var(--azul);
        }

        select.turno-select.selected {
            background-color: var(--verde);
            color: white;
            border-color: var(--verde);
        }

        select.turno-select.selected[value="C"] {
            background-color: var(--roxo);
            border-color: var(--roxo);
        }

        select.turno-select.selected[value="ABC"] {
            background-color: var(--laranja);
            border-color: var(--laranja);
        }

        select.turno-select:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .total-box {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .total-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .total-valor {
            font-size: 1.5rem;
            color: var(--verde);
        }

        .turno-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .legend-color.a { background-color: var(--verde); }
        .legend-color.b { background-color: #95a5a6; }
        .legend-color.c { background-color: var(--roxo); }
        .legend-color.ab { background-color: var(--azul); }
        .legend-color.abc { background-color: var(--laranja); }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .app-title {
                font-size: 1.5rem;
            }
            
            .escala-title {
                font-size: 1.2rem;
            }
            
            th, td {
                padding: 8px;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1 class="app-title">üìÖ Gerador de Escala Mensal</h1>
            <p class="app-subtitle">Gere e baixe escalas de trabalho para vigilantes</p>
        </header>

        <div class="pwa-status" id="pwaStatus"></div>

        <div class="controls-grid">
            <div class="control-card">
                <h3>üë• Lista de Vigilantes</h3>
                <div class="input-group">
                    <label for="listaNomes">Nomes (separados por v√≠rgula, m√°ximo 20):</label>
                    <textarea 
                        id="listaNomes" 
                        placeholder="Ex: Jo√£o Silva, Maria Santos, Pedro Costa"
                        rows="4"></textarea>
                </div>
            </div>

            <div class="control-card">
                <h3>‚öôÔ∏è Configura√ß√µes</h3>
                <div class="input-group">
                    <label for="mesSelecionado">M√™s e Ano:</label>
                    <input type="month" id="mesSelecionado">
                </div>
                
                <div class="input-group">
                    <label for="turnoPadrao">Turno Padr√£o (gera√ß√£o autom√°tica):</label>
                    <select id="turnoPadrao" class="turno-select">
                        <option value="A">Turno A (R$ 90-110)</option>
                        <option value="B">Turno B (R$ 80)</option>
                        <option value="C">Turno C (R$ 100)</option>
                        <option value="AB">Turno AB (R$ 170-190)</option>
                        <option value="ABC">Turno ABC (R$ 270-290)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="actions-grid">
            <button id="btnGerarAleatorio" class="btn btn-success">üé≤ Gerar Aleat√≥rio</button>
            <button id="btnGerarBaixar" class="btn btn-primary">üì• Gerar & Baixar Manual</button>
            <button id="btnResetMemoria" class="btn btn-warning">üóëÔ∏è Resetar Mem√≥ria</button>
            <button id="installButton" class="btn btn-install">üì± Instalar App</button>
        </div>

        <div class="escala-container">
            <div class="escala-header">
                <h2 class="escala-title">Escala do M√™s</h2>
                <p class="escala-subtitle">Selecione os turnos para cada dia e loja</p>
            </div>

            <div class="table-responsive">
                <table id="tabelaEscala">
                    <thead>
                        <tr>
                            <th>Dia</th>
                            <th>PV</th>
                            <th>PG</th>
                            <th>WS</th>
                            <th>BM</th>
                            <th>ML</th>
                            <th>PK</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="total-box">
                <span class="total-label">Total a Receber:</span>
                <span class="total-valor">R$ <span id="totalValor">0,00</span></span>
            </div>

            

    <script>
        // ===== CONFIGURA√á√ïES INICIAIS =====
        const rates = {
            PV: { 
                A: 110.00, 
                B: 80.00, 
                C: 100.00,
                AB: 190.00,
                ABC: 290.00
            },
            PK: { 
                A: 105.00, 
                B: 80.00, 
                C: 100.00,
                AB: 185.00,
                ABC: 285.00
            },
            PG: { 
                A: 90.00,  
                B: 80.00,
                C: 100.00,
                AB: 170.00,
                ABC: 270.00
            },
            BM: { 
                A: 90.00,  
                B: 80.00,
                C: 100.00,
                AB: 170.00,
                ABC: 270.00
            },
            ML: { 
                A: 90.00,  
                B: 80.00,
                C: 100.00,
                AB: 170.00,
                ABC: 270.00
            },
            WS: { 
                A: 90.00,  
                B: 80.00,
                C: 100.00,
                AB: 170.00,
                ABC: 270.00
            }
        };

        const lojas = ["PV", "PG", "WS", "BM", "ML", "PK"];
        const STORAGE_KEY = 'escala_vigilante_memoria_v4';
        
        // Elementos DOM
        const elements = {
            mesInput: document.getElementById('mesSelecionado'),
            tabelaBody: document.querySelector('#tabelaEscala tbody'),
            btnGerarBaixar: document.getElementById('btnGerarBaixar'),
            btnGerarAleatorio: document.getElementById('btnGerarAleatorio'),
            btnResetMemoria: document.getElementById('btnResetMemoria'),
            nomeInput: document.getElementById('listaNomes'),
            totalSpan: document.getElementById('totalValor'),
            turnoPadrao: document.getElementById('turnoPadrao'),
            installButton: document.getElementById('installButton'),
            pwaStatus: document.getElementById('pwaStatus')
        };

        // Estado da aplica√ß√£o
        let state = {
            totalCalculado: 0,
            includeMemoryInTotal: true,
            memoriaDias: loadMemoria(),
            deferredPrompt: null
        };

        // ===== FUN√á√ïES UTILIT√ÅRIAS =====
        function formatMoneyBR(valor) {
            return valor.toFixed(2).replace('.', ',');
        }

        function formatarMesLabel(mesValor) {
            if (!mesValor) return '';
            const [ano, mes] = mesValor.split('-');
            const nomeMes = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ][parseInt(mes) - 1];
            return `${nomeMes} de ${ano}`;
        }

        function showNotification(message) {
            alert(message);
        }

        // ===== GERENCIAMENTO DE MEM√ìRIA =====
        function loadMemoria() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) {
                    let base = {}; 
                    lojas.forEach(l => base[l] = {});
                    return base;
                }
                const parsed = JSON.parse(raw);
                lojas.forEach(l => { if (!parsed[l]) parsed[l] = {}; });
                return parsed;
            } catch {
                let base = {}; 
                lojas.forEach(l => base[l] = {});
                return base;
            }
        }

        function saveMemoria() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.memoriaDias)); 
        }

        // ===== FUN√á√ïES DA TABELA =====
        function gerarTabela() {
            state.totalCalculado = 0;
            const mesValor = elements.mesInput.value;
            
            if (!mesValor) {
                showNotification('Selecione um m√™s e ano');
                return;
            }

            const [anoStr, mesStr] = mesValor.split('-');
            const ano = parseInt(anoStr, 10);
            const mes = parseInt(mesStr, 10);
            const diasNoMes = new Date(ano, mes, 0).getDate();

            elements.tabelaBody.innerHTML = '';

            for (let dia = 1; dia <= diasNoMes; dia++) {
                const tr = document.createElement('tr');
                
                const tdDia = document.createElement('td');
                tdDia.textContent = dia;
                tr.appendChild(tdDia);

                lojas.forEach(loja => {
                    const td = document.createElement('td');
                    const select = document.createElement('select');
                    select.className = 'turno-select';
                    select.innerHTML = `
                        <option value=""></option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="AB">AB</option>
                        <option value="ABC">ABC</option>
                    `;
                    select.dataset.loja = loja;
                    select.dataset.dia = dia;

                    const memVal = state.memoriaDias[loja] && state.memoriaDias[loja][dia];
                    
                    if (memVal) {
                        select.value = memVal;
                        select.disabled = true;
                        select.classList.add('selected');
                    } else {
                        select.addEventListener('change', function() {
                            if (this.value) {
                                this.classList.add('selected');
                            } else {
                                this.classList.remove('selected');
                            }
                            atualizarTotal();
                        });
                    }

                    td.appendChild(select);
                    tr.appendChild(td);
                });

                elements.tabelaBody.appendChild(tr);
            }

            atualizarTotal();
        }

        function atualizarTotal() {
            state.totalCalculado = 0;

            if (state.includeMemoryInTotal) {
                lojas.forEach(loja => {
                    const dias = state.memoriaDias[loja] || {};
                    Object.keys(dias).forEach(d => {
                        const escolha = dias[d];
                        if (!escolha) return;
                        const valorObj = rates[loja];
                        if (!valorObj || !valorObj[escolha]) return;
                        state.totalCalculado += valorObj[escolha];
                    });
                });
            }

            document.querySelectorAll('#tabelaEscala tbody select').forEach(sel => {
                if (sel.disabled || !sel.value) return;
                const loja = sel.dataset.loja;
                const escolha = sel.value;
                const valorObj = rates[loja];
                if (!valorObj || !valorObj[escolha]) return;
                state.totalCalculado += valorObj[escolha];
            });

            elements.totalSpan.textContent = formatMoneyBR(state.totalCalculado);
        }

        // ===== FUN√á√ïES DE GERA√á√ÉO DE IMAGEM =====
        function buildEscalaVisualParaVigilante(nomeVig, mesValor, assignmentsByDay) {
            const container = document.createElement('div');
            container.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                border: 1px solid #ddd;
                width: 100%;
                max-width: 800px;
                margin: 0 auto;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;

            const title = document.createElement('div');
            title.style.cssText = `
                text-align: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #3498db;
            `;
            title.innerHTML = `
                <h2 style="color: #2c3e50; font-size: 24px; margin-bottom: 5px;">
                    Escala do Vigilante: <span style="color: #0044cc; font-weight: 800;">${nomeVig}</span>
                </h2>
                <p style="color: #7f8c8d; font-size: 16px;">M√™s: ${formatarMesLabel(mesValor)}</p>
            `;
            container.appendChild(title);

            const table = document.createElement('table');
            table.style.cssText = `
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
                font-size: 14px;
            `;

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">Dia</th>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">PV</th>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">PG</th>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">WS</th>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">BM</th>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">ML</th>
                    <th style="background: #009879; color: white; padding: 10px; border: 1px solid #ddd;">PK</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const dias = Object.keys(assignmentsByDay).map(k => parseInt(k, 10)).sort((a, b) => a - b);
            
            dias.forEach(d => {
                const tr = document.createElement('tr');
                const tdDia = document.createElement('td');
                tdDia.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold;';
                tdDia.textContent = d;
                tr.appendChild(tdDia);

                lojas.forEach(loja => {
                    const td = document.createElement('td');
                    td.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: bold; color: #000000;';
                    const turno = (assignmentsByDay[d] && assignmentsByDay[d][loja]) || '';
                    td.textContent = turno;
                    
                    // REMOVIDO: Cores de fundo para os turnos
                    // if (turno === 'C') {
                    //     td.style.background = '#9b59b6';
                    //     td.style.color = 'white';
                    // } else if (turno === 'ABC') {
                    //     td.style.background = '#e67e22';
                    //     td.style.color = 'white';
                    // } else if (turno) {
                    //     td.style.background = '#2ecc71';
                    //     td.style.color = 'white';
                    // }
                    
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);

            let total = 0;
            dias.forEach(d => {
                lojas.forEach(loja => {
                    const turno = assignmentsByDay[d] && assignmentsByDay[d][loja];
                    if (!turno) return;
                    const valObj = rates[loja];
                    if (!valObj || !valObj[turno]) return;
                    total += valObj[turno];
                });
            });

            const totalDiv = document.createElement('div');
            totalDiv.style.cssText = `
                margin-top: 20px;
                padding: 15px;
                border-radius: 8px;
                background: #34495e;
                color: white;
                text-align: center;
                font-size: 18px;
                font-weight: bold;
            `;
            totalDiv.textContent = `Total a receber: R$ ${formatMoneyBR(total)}`;
            container.appendChild(totalDiv);

            return { element: container, total };
        }

        // ===== FUN√á√ïES DE DISTRIBUI√á√ÉO AUTOM√ÅTICA =====
        function gerarDistribuicaoAutomatica(vigilantes, mesValor, turnoPadraoValue) {
            const [anoStr, mesStr] = mesValor.split('-');
            const ano = parseInt(anoStr, 10);
            const mes = parseInt(mesStr, 10);
            const diasNoMes = new Date(ano, mes, 0).getDate();

            const N = vigilantes.length;
            const result = {};
            for (let i = 0; i < N; i++) result[vigilantes[i]] = {};

            const occupied = {};
            for (let d = 1; d <= diasNoMes; d++) { 
                occupied[d] = {}; 
                lojas.forEach(l => occupied[d][l] = false); 
            }

            const targetFirst12 = Math.ceil(diasNoMes / 2);
            const firstCount = Math.min(12, N);

            for (let i = 0; i < firstCount; i++) {
                const name = vigilantes[i];
                const startsOdd = (i < 6);
                let assignedCount = 0;
                let storeStep = 0;
                let startDay = startsOdd ? 1 : 2;
                
                for (let day = startDay; day <= diasNoMes && assignedCount < targetFirst12; day += 2) {
                    let lojaIndex = storeStep % lojas.length;
                    let loja = lojas[lojaIndex];
                    let attempts = 0;
                    
                    while (attempts < lojas.length) {
                        lojaIndex = (storeStep + attempts) % lojas.length;
                        loja = lojas[lojaIndex];
                        
                        if (!occupied[day][loja]) {
                            result[name][day] = result[name][day] || {};
                            result[name][day][loja] = turnoPadraoValue;
                            occupied[day][loja] = true;
                            assignedCount++;
                            storeStep = lojaIndex + 1;
                            break;
                        }
                        attempts++;
                    }
                }
            }

            if (N > firstCount) {
                const rest = vigilantes.slice(firstCount);
                let restIdx = 0;
                
                for (let day = 1; day <= diasNoMes; day++) {
                    for (let s = 0; s < lojas.length; s++) {
                        const loja = lojas[s];
                        if (occupied[day][loja]) continue;
                        const who = rest[restIdx % rest.length];
                        result[who][day] = result[who][day] || {};
                        result[who][day][loja] = turnoPadraoValue;
                        occupied[day][loja] = true;
                        restIdx++;
                    }
                }
            }

            return result;
        }

        function extrairDadosDaTabela() {
            const assignmentsByDay = {};
            const selects = document.querySelectorAll('#tabelaEscala tbody select');
            
            selects.forEach(select => {
                const dia = select.dataset.dia;
                const loja = select.dataset.loja;
                const valor = select.value;
                
                if (valor) {
                    if (!assignmentsByDay[dia]) {
                        assignmentsByDay[dia] = {};
                    }
                    assignmentsByDay[dia][loja] = valor;
                }
            });
            
            return assignmentsByDay;
        }

        // ===== FUN√á√ïES DE CAPTURA DE TELA =====
        async function capturarElementoComoJPEG(element, filename) {
            return new Promise((resolve) => {
                // Criar um container tempor√°rio
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = `
                    position: fixed;
                    top: -10000px;
                    left: -10000px;
                    width: 800px;
                `;
                tempContainer.appendChild(element);
                document.body.appendChild(tempContainer);

                // Aguardar um momento para o elemento ser renderizado
                setTimeout(async () => {
                    try {
                        const canvas = await html2canvas(element, {
                            scale: 2,
                            backgroundColor: '#ffffff',
                            logging: false
                        });

                        canvas.toBlob(blob => {
                            if (!blob) {
                                tempContainer.remove();
                                resolve(false);
                                return;
                            }

                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            tempContainer.remove();
                            resolve(true);
                        }, 'image/jpeg', 0.95);
                    } catch (error) {
                        console.error('Erro ao capturar imagem:', error);
                        tempContainer.remove();
                        resolve(false);
                    }
                }, 100);
            });
        }

        // ===== HANDLERS DE EVENTOS =====
        async function handleGerarAleatorio() {
            const raw = elements.nomeInput.value.trim();
            if (!raw) {
                showNotification('Insira ao menos um nome (separados por v√≠rgula).');
                return;
            }
            
            const names = raw.split(',').map(s => s.trim()).filter(s => s).slice(0, 20);
            if (names.length === 0) {
                showNotification('Nenhum nome v√°lido encontrado.');
                return;
            }
            
            const mesValor = elements.mesInput.value;
            if (!mesValor) {
                showNotification('Selecione o m√™s e ano.');
                return;
            }
            
            const turnoValue = elements.turnoPadrao.value || 'A';
            const distrib = gerarDistribuicaoAutomatica(names, mesValor, turnoValue);

            for (const nomeVig of names) {
                const assignments = distrib[nomeVig] || {};
                const built = buildEscalaVisualParaVigilante(nomeVig, mesValor, assignments);
                const filename = `escala_${nomeVig.replace(/\s+/g, '_')}_${mesValor}.jpg`;
                const ok = await capturarElementoComoJPEG(built.element, filename);
                
                if (!ok) {
                    showNotification(`Erro ao gerar imagem de ${nomeVig}`);
                    continue;
                }

                // Salvar na mem√≥ria
                Object.keys(assignments).forEach(dayStr => {
                    const day = String(dayStr);
                    const dayObj = assignments[dayStr];
                    lojas.forEach(loja => {
                        if (dayObj && dayObj[loja]) {
                            state.memoriaDias[loja] = state.memoriaDias[loja] || {};
                            state.memoriaDias[loja][day] = dayObj[loja];
                        }
                    });
                });
            }

            saveMemoria();
            state.includeMemoryInTotal = false;
            state.totalCalculado = 0;
            elements.totalSpan.textContent = formatMoneyBR(0);
            gerarTabela();
            
            showNotification('Gera√ß√£o autom√°tica conclu√≠da! Imagens baixadas e mem√≥ria atualizada.');
        }

        async function handleGerarBaixar() {
            let manualNome = '';
            const rawList = elements.nomeInput.value.trim();
            
            if (rawList) {
                manualNome = rawList.split(',')[0].trim().toUpperCase();
            }

            const nome = manualNome || 'VIGILANTE';
            const mes = elements.mesInput.value || new Date().toISOString().slice(0, 7);
            const assignments = extrairDadosDaTabela();
            const built = buildEscalaVisualParaVigilante(nome, mes, assignments);
            const filename = `escala_${nome.replace(/\s+/g, '_')}_${mes}.jpg`;
            const ok = await capturarElementoComoJPEG(built.element, filename);

            if (!ok) {
                showNotification('Erro ao gerar imagem.');
                return;
            }

            // Salvar sele√ß√µes na mem√≥ria
            document.querySelectorAll('#tabelaEscala tbody select').forEach(sel => {
                if (sel.disabled || !sel.value) return;
                const loja = sel.dataset.loja;
                const dia = String(sel.dataset.dia);
                state.memoriaDias[loja] = state.memoriaDias[loja] || {};
                state.memoriaDias[loja][dia] = sel.value;
            });

            saveMemoria();
            state.includeMemoryInTotal = false;
            state.totalCalculado = 0;
            elements.totalSpan.textContent = formatMoneyBR(0);
            gerarTabela();
            
            showNotification('Escala gerada e baixada com sucesso!');
        }

        function handleResetMemoria() {
            if (!confirm('Tem certeza que deseja apagar toda a mem√≥ria da escala?')) return;
            
            state.memoriaDias = {};
            lojas.forEach(l => state.memoriaDias[l] = {});
            saveMemoria();
            state.includeMemoryInTotal = true;
            state.totalCalculado = 0;
            elements.totalSpan.textContent = formatMoneyBR(0);
            gerarTabela();
            
            showNotification('Mem√≥ria resetada com sucesso!');
        }

        // ===== PWA FUNCTIONALITY =====
        function initPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                elements.installButton.style.display = 'block';
                elements.pwaStatus.textContent = 'Este app pode ser instalado no seu dispositivo!';
                elements.pwaStatus.style.display = 'block';
            });

            elements.installButton.addEventListener('click', async () => {
                if (!state.deferredPrompt) return;
                
                state.deferredPrompt.prompt();
                const { outcome } = await state.deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showNotification('App instalado com sucesso!');
                    elements.installButton.style.display = 'none';
                } else {
                    showNotification('Instala√ß√£o cancelada.');
                }
                
                state.deferredPrompt = null;
            });

            window.addEventListener('appinstalled', () => {
                elements.installButton.style.display = 'none';
                elements.pwaStatus.textContent = 'App instalado! Agora voc√™ pode us√°-lo offline.';
            });
        }

        // ===== SERVICE WORKER REGISTRATION =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }

        // ===== INICIALIZA√á√ÉO =====
        function init() {
            const hoje = new Date();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            
            if (!elements.mesInput.value) {
                elements.mesInput.value = `${ano}-${mes}`;
            }

            elements.mesInput.addEventListener('change', gerarTabela);
            elements.btnGerarAleatorio.addEventListener('click', handleGerarAleatorio);
            elements.btnGerarBaixar.addEventListener('click', handleGerarBaixar);
            elements.btnResetMemoria.addEventListener('click', handleResetMemoria);

            initPWA();
            gerarTabela();
        }

        // Inicia a aplica√ß√£o
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>